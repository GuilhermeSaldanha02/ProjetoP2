<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Luxo - Mensagens Recebidas</title>
    <link rel="shortcut icon" href="images/barco2.png" type="image/x-icon" />
    <link rel="stylesheet" href="css/default.css" />
    <style>
      /* Estilos específicos para a tabela */
      main { padding-bottom: 50px; }
      .table-container { width: 90%; margin: 40px auto; overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
      th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ddd; }
      th { background-color: var(--darkblue); color: white; text-transform: uppercase; font-size: 0.85em; }
      .nao-lida { font-weight: 700; color: #000; }
      .lida { font-weight: 400; color: #555; }
      .btn-action { padding: 8px 12px; margin-right: 5px; border: none; cursor: pointer; font-size: 0.8em; border-radius: 3px; color: white; transition: 0.3s; }
      .btn-ver { background-color: var(--lightblue); }
      .btn-ver:hover { background-color: var(--darkblue); }
      .btn-del { background-color: #c0392b; }
      .btn-del:hover { background-color: #a93226; }
    </style>
  </head>

  <body>
    <div class="page">
      <header>
        <div id="title">
          <img src="images/barco1.png" alt="ícone de barco" />
          <div class="headtitle">
            <h1>Luxo</h1>
            <h2>Aluguel de iates</h2>
          </div>
        </div>
        <nav>
          <ul class="navmenu">
            <li><a href="index.html">Voltar ao Site</a></li>
            <li><a href="#" id="btn-sair">Sair</a></li>
          </ul>
        </nav>
      </header>

      <main>
        <div class="pagtitle">
          <div class="bgtitle"></div>
          <h2>Painel de Mensagens</h2>
        </div>

        <div class="table-container">
          <table id="tabela-mensagens">
            <thead>
              <tr>
                <th>Nome</th>
                <th>E-mail</th>
                <th>Mensagem</th>
                <th style="width: 220px;">Ações</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <p id="loading" style="text-align:center; padding:20px;">Carregando...</p>
          <p id="no-msg" style="text-align:center; padding:20px; display:none;">Nenhuma mensagem encontrada.</p>
        </div>
      </main>
    </div>

    <footer>
      <p>© 2023 por Luxo aluguel de iates</p>
    </footer>

    <script src="js/jquery-3.6.4.min.js"></script>
    <script src="js/api.js?v=2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      $(document).ready(function() {
        if (sessionStorage.getItem('isLogged') !== 'true') {
          Swal.fire({
              title: 'Acesso Negado',
              text: 'Você precisa fazer login.',
              icon: 'warning'
          }).then(() => {
              window.location.href = 'admin.html';
          });
          return;
        }

        $('#btn-sair').click(function(e) {
          e.preventDefault();
          sessionStorage.removeItem('isLogged');
          window.location.href = 'admin.html';
        });

        carregarTabela();

        function carregarTabela() {
            $('#loading').show();
            $('#no-msg').hide();
            
            obterMensagens()
                .done(function(mensagensAPI) {
                   renderizar(mensagensAPI);
                })
                .fail(function() {
                   $('#tabela-mensagens tbody').html('<tr><td colspan="4" style="color:red;text-align:center">Erro ao carregar API</td></tr>');
                })
                .always(function() {
                   $('#loading').hide();
                });
        }

        function renderizar(mensagensAPI) {
            var statusLocal = JSON.parse(localStorage.getItem('msgStatus')) || {};
            var tbody = $('#tabela-mensagens tbody');
            tbody.empty();
            var count = 0;

            if (!mensagensAPI || mensagensAPI.length === 0) {
              $('#no-msg').show();
              return;
            }

            mensagensAPI.forEach(function(msg, index) {
              var idUnico = btoa(msg.email + msg.mensagem + index);

              if (statusLocal[idUnico] && statusLocal[idUnico].excluida) return;

              var classeEstilo = 'nao-lida';
              if (statusLocal[idUnico] && statusLocal[idUnico].lida) {
                classeEstilo = 'lida';
              }

              var tr = `
                <tr class="${classeEstilo}" id="${idUnico}">
                  <td>${msg.nome}</td>
                  <td>${msg.email}</td>
                  <td>${msg.mensagem}</td>
                  <td>
                    <button class="btn-action btn-ver" onclick="marcarLida('${idUnico}')">
                      Visualizada
                    </button>
                    <button class="btn-action btn-del" onclick="excluirMsg('${idUnico}')">
                      Excluir
                    </button>
                  </td>
                </tr>
              `;
              tbody.append(tr);
              count++;
            });

            if (count === 0) $('#no-msg').show();
        }

        window.marcarLida = function(id) {
          Swal.fire({
              title: 'Marcar como lida?',
              icon: 'question',
              showCancelButton: true,
              confirmButtonColor: '#1bb4e8',
              confirmButtonText: 'Sim',
              cancelButtonText: 'Cancelar'
          }).then((result) => {
              if (result.isConfirmed) {
                  var statusLocal = JSON.parse(localStorage.getItem('msgStatus')) || {};
                  if(!statusLocal[id]) statusLocal[id] = {};
                  statusLocal[id].lida = true;
                  localStorage.setItem('msgStatus', JSON.stringify(statusLocal));
                  
                  // CORREÇÃO AQUI: Usamos document.getElementById para evitar erro de sintaxe do jQuery com caracteres especiais do Base64
                  $(document.getElementById(id)).removeClass('nao-lida').addClass('lida');
                  
                  const Toast = Swal.mixin({
                      toast: true, position: 'top-end', showConfirmButton: false, timer: 2000
                  });
                  Toast.fire({ icon: 'success', title: 'Marcada como visualizada' });
              }
          });
        };

        window.excluirMsg = function(id) {
          Swal.fire({
              title: 'Tem certeza?',
              text: "Você não poderá reverter isso!",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#d33',
              cancelButtonColor: '#3085d6',
              confirmButtonText: 'Sim, excluir!'
          }).then((result) => {
              if (result.isConfirmed) {
                  var statusLocal = JSON.parse(localStorage.getItem('msgStatus')) || {};
                  if(!statusLocal[id]) statusLocal[id] = {};
                  statusLocal[id].excluida = true;
                  localStorage.setItem('msgStatus', JSON.stringify(statusLocal));
                  
                  // CORREÇÃO AQUI TAMBÉM
                  $(document.getElementById(id)).fadeOut(300, function(){ $(this).remove(); });
                  Swal.fire('Excluído!', 'A mensagem foi removida.', 'success');
              }
          });
        };
      });
    </script>
  </body>
</html>